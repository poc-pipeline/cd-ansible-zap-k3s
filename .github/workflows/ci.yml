name: CI â€” Build and Push

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: [self-hosted, local-poc]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and push container image
        run: |
          podman build \
            -t localhost:5000/sample-app:${{ github.sha }} \
            ./sample-app
          podman push localhost:5000/sample-app:${{ github.sha }}

      - name: Trigger AWX CD pipeline
        run: |
          curl --fail --silent --show-error \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.AWX_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"extra_vars": {"image_tag": "${{ github.sha }}"}}' \
            "http://localhost:8043/api/v2/workflow_job_templates/${{ secrets.AWX_WORKFLOW_TEMPLATE_ID }}/launch/"
